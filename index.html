<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel CRM</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Tailwind Configuration -->
    <script>
        window.tailwind = {
            config: {
                darkMode: 'class',
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'sans-serif'],
                            mono: ['JetBrains Mono', 'monospace'],
                        },
                        animation: {
                            'fade-in': 'fadeIn 0.5s ease-out forwards',
                            'slide-up': 'slideUp 0.4s ease-out forwards',
                            'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        },
                        keyframes: {
                            fadeIn: {
                                '0%': { opacity: '0' },
                                '100%': { opacity: '1' },
                            },
                            slideUp: {
                                '0%': { opacity: '0', transform: 'translateY(20px)' },
                                '100%': { opacity: '1', transform: 'translateY(0)' },
                            },
                            shake: {
                                '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                                '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                                '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                                '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                            }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #0b1121; /* Darker slate */
            color: #f1f5f9;
            background-image: 
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .card-glass {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Hover lift effect */
        .hover-lift {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
            border-color: rgba(96, 165, 250, 0.3); /* Blue tint on hover */
        }

        /* Fix for Date/Select Inputs in Dark Mode */
        ::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        ::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
        
        /* Custom Select Arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        /* Keyframes explicitly defined for CSS classes */
        @keyframes slideUp {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        /* Stagger animation class */
        .stagger-item {
            opacity: 0; /* Starts invisible, becomes visible via animation */
            animation: slideUp 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="overflow-hidden selection:bg-indigo-500/30 text-sm md:text-base h-screen flex flex-col">

    <!-- HIDDEN FILE INPUT for PO Upload -->
    <input type="file" id="po-uploader" class="hidden" accept=".pdf,.doc,.docx,.jpg,.png" onchange="app.handleFileSelection(this)">

    <!-- LOGIN SCREEN -->
    <div id="login-section" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4 bg-[#0b1121] bg-[radial-gradient(at_0%_0%,rgba(56,189,248,0.1)_0px,transparent_50%),radial-gradient(at_100%_100%,rgba(139,92,246,0.1)_0px,transparent_50%)] backdrop-blur-xl transition-all duration-700">
        <div class="w-full max-w-sm">
            <div id="login-card" class="card-glass p-8 rounded-2xl shadow-2xl border border-slate-700/50 relative overflow-hidden">
                <div class="absolute -top-20 -right-20 w-40 h-40 bg-indigo-500/20 rounded-full blur-3xl"></div>
                <div class="absolute -bottom-20 -left-20 w-40 h-40 bg-blue-500/20 rounded-full blur-3xl"></div>

                <div class="relative z-10 flex flex-col items-center">
                    <div class="w-12 h-12 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20 mb-6">
                        <i data-lucide="lock" class="text-white w-6 h-6"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white mb-2">Pixel CRM</h1>
                    <p class="text-slate-400 text-sm mb-8 text-center">Enter your access code to continue</p>

                    <form onsubmit="handleLogin(event)" class="w-full space-y-4">
                        <div class="space-y-1">
                            <label class="text-xs font-semibold text-slate-400 uppercase tracking-wide ml-1">Password</label>
                            <div class="relative group">
                                <i data-lucide="key" class="absolute left-4 top-3.5 text-slate-500 w-5 h-5 group-focus-within:text-indigo-400 transition-colors"></i>
                                <input id="password-input" type="password" placeholder="•••••" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl pl-12 pr-4 py-3 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all text-white placeholder-slate-600 tracking-widest">
                            </div>
                            <p id="login-error" class="text-red-400 text-xs mt-2 hidden flex items-center gap-1">
                                <i data-lucide="alert-circle" class="w-3 h-3"></i> Incorrect password
                            </p>
                        </div>
                        <button type="submit" class="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white shadow-lg shadow-blue-500/25 active:scale-95 transition-all mt-2 flex items-center justify-center gap-2 group">
                            Login <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </form>
                </div>
            </div>
            <div class="mt-6 text-center animate-fade-in" style="animation-delay: 0.2s">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800/50 border border-slate-700/50 text-slate-400 text-xs font-mono">
                    <i data-lucide="info" class="w-3 h-3 text-indigo-400"></i>
                    <span>Password is: <span class="text-white font-bold tracking-wider">12345</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="crm-app" class="hidden flex flex-col h-screen overflow-hidden opacity-0 transition-opacity duration-700">
        <!-- 1. Main Header -->
        <header class="glass h-16 shrink-0 flex items-center justify-between px-4 md:px-6 z-30 relative">
            <div class="flex items-center gap-3 group cursor-default">
                <div class="w-9 h-9 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20 group-hover:scale-105 transition-transform duration-300">
                    <i data-lucide="layout-dashboard" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <span class="text-lg md:text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white via-blue-100 to-slate-400">
                        Pixel CRM
                    </span>
                </div>
            </div>

            <!-- Desktop Search Bar -->
            <div class="flex-1 max-w-lg mx-6 hidden md:block">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-slate-500 group-focus-within:text-blue-400 transition-colors"></i>
                    </div>
                    <input type="text" oninput="app.handleSearch(this.value)" 
                        class="block w-full pl-10 pr-3 py-2 border border-slate-700 rounded-xl leading-5 bg-slate-900/50 text-slate-300 placeholder-slate-500 focus:outline-none focus:bg-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 sm:text-sm transition-all" 
                        placeholder="Search by Serial No, Email, or Phone...">
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-semibold text-slate-200">Admin User</p>
                    <div class="flex items-center justify-end gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        <p class="text-xs text-slate-400 font-mono">v2.3.0</p>
                    </div>
                </div>
                <div class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-xs font-bold text-white border border-slate-600 shadow-inner ring-2 ring-slate-800 ring-offset-2 ring-offset-slate-900 cursor-pointer hover:ring-blue-500 transition-all">
                    AD
                </div>
            </div>
        </header>

        <!-- 2. Navigation Bar -->
        <nav class="bg-slate-900/50 border-b border-slate-800 px-4 md:px-6 shrink-0 z-20 overflow-x-auto no-scrollbar">
            <div class="flex items-center gap-6 md:gap-8 min-w-max" id="main-nav">
                <!-- Nav buttons injected by JS -->
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden relative">
            
            <!-- 3. Page Header & Sub-Navigation -->
            <div class="min-h-16 h-auto border-b border-slate-800/50 bg-slate-900/20 backdrop-blur-sm flex flex-col md:flex-row items-start md:items-center justify-between px-4 md:px-6 py-3 md:py-0 sticky top-0 z-10 shrink-0 gap-3 md:gap-0">
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 md:gap-6 w-full md:w-auto">
                    <h1 class="text-2xl font-bold capitalize flex items-center gap-2 min-w-[120px] transition-all duration-300" id="page-title">
                        <!-- Title injected by JS -->
                    </h1>

                    <!-- Sub-tab Pill Selector -->
                    <div class="bg-slate-800/80 p-1 rounded-lg flex text-xs font-medium border border-slate-700/50 shadow-inner w-full sm:w-auto" id="subtab-container">
                        <button id="btn-subtab-active" onclick="app.setSubTab('active')" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md transition-all duration-300 ease-out text-center">
                            Active
                        </button>
                        <button id="btn-subtab-dead" onclick="app.setSubTab('dead')" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md transition-all duration-300 ease-out text-center">
                            Dead / Lost
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 w-full md:w-auto justify-end" id="header-actions">
                    <!-- Add Button injected by JS -->
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
                
                <!-- Mobile Search Bar (Visible only on small screens) -->
                <div class="mb-6 block md:hidden">
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="w-4 h-4 text-slate-500 group-focus-within:text-blue-400 transition-colors"></i>
                        </div>
                        <input type="text" oninput="app.handleSearch(this.value)" 
                            class="block w-full pl-10 pr-3 py-3 border border-slate-700 rounded-xl leading-5 bg-slate-900/50 text-slate-300 placeholder-slate-500 focus:outline-none focus:bg-slate-900 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-sm transition-all" 
                            placeholder="Search records...">
                    </div>
                </div>

                <!-- Stats Row -->
                <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <!-- Stats cards injected by JS -->
                </div>

                <!-- List Area -->
                <div id="items-list" class="space-y-4 pb-20 md:pb-10">
                    <!-- Items injected by JS -->
                </div>

                <!-- Footer / Disclaimer Card -->
                <div class="mt-8 mb-4 p-6 rounded-xl border border-indigo-500/30 bg-gradient-to-r from-indigo-900/20 to-blue-900/20 backdrop-blur-md text-center shadow-lg relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 to-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <div class="relative z-10">
                        <h3 class="text-indigo-300 font-semibold text-sm uppercase tracking-wider mb-2 flex items-center justify-center gap-2">
                            <i data-lucide="sparkles" class="w-4 h-4"></i> Demo Environment
                        </h3>
                        <p class="text-slate-300 text-sm leading-relaxed max-w-3xl mx-auto">
                            This is a prototype CRM model designed for exploration purposes. 
                            We specialize in building <span class="text-indigo-200 font-semibold">bespoke applications</span> tailored specifically to your 
                            unique business workflows and operational requirements.
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- --- Modals --- -->

    <!-- Add Enquiry Modal -->
    <div id="modal-add" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-slate-900 border border-slate-700/50 rounded-2xl w-full max-w-2xl p-0 shadow-2xl transform transition-all scale-100 ring-1 ring-white/10 max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header with bottom border for separation -->
            <div class="p-4 md:p-6 pb-4 bg-slate-900/95 backdrop-blur-md sticky top-0 z-10 border-b border-slate-800">
                <h2 class="text-xl md:text-2xl font-bold flex items-center gap-3 text-white">
                    <div class="p-2 bg-blue-500/20 rounded-lg text-blue-400">
                        <i data-lucide="plus" class="w-5 h-5 md:w-6 md:h-6"></i>
                    </div>
                    New Enquiry
                </h2>
            </div>
            
            <!-- Scrollable Content -->
            <div class="p-4 md:p-6 overflow-y-auto">
                <form onsubmit="app.handleAddEnquiry(event)" class="space-y-5">
                    <!-- Section: Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="group">
                            <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Date</label>
                            <div class="relative">
                                <i data-lucide="calendar" class="absolute left-4 top-3.5 text-slate-500 w-5 h-5 group-focus-within:text-blue-400 transition-colors"></i>
                                <input required type="date" id="input-date" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl pl-12 pr-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600 appearance-none">
                            </div>
                        </div>
                        <div class="group">
                            <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Contact Person Name</label>
                            <input required type="text" id="input-name" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600" placeholder="e.g. John Doe">
                        </div>
                    </div>

                    <!-- Section: Company Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="group">
                            <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Company Name</label>
                            <input required type="text" id="input-company" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600" placeholder="e.g. Acme Industries">
                        </div>
                        <div class="group">
                            <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Company Website (Optional)</label>
                            <input type="url" id="input-website" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600" placeholder="https://">
                        </div>
                    </div>

                    <!-- Section: Contact Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="group">
                            <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Mobile Number</label>
                            <input required type="tel" id="input-mobile" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600">
                        </div>
                        <div class="group">
                            <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Company Email</label>
                            <input required type="email" id="input-email" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600">
                        </div>
                    </div>

                    <!-- Section: Addresses -->
                    <div class="group">
                        <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Personal/Contact Address</label>
                        <input required type="text" id="input-address" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600">
                    </div>
                    <div class="group">
                        <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Company Address</label>
                        <input required type="text" id="input-company-address" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600">
                    </div>

                    <!-- Section: Location -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="group">
                            <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Country</label>
                            <select required id="input-country" onchange="app.populateStates()" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600">
                                <option value="" disabled selected>Select Country</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="group">
                            <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">State / Province</label>
                            <select required id="input-state" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-white placeholder-slate-600">
                                <option value="" disabled selected>Select Country First</option>
                            </select>
                        </div>
                    </div>

                    <div class="group">
                        <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide group-focus-within:text-blue-400 transition-colors">Requirement Description</label>
                        <textarea required rows="3" id="input-desc" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all resize-none text-white placeholder-slate-600"></textarea>
                    </div>

                    <div class="flex flex-col-reverse sm:flex-row gap-4 pt-6 mt-4 border-t border-slate-800">
                        <button type="button" onclick="app.toggleModal('modal-add', false)" class="flex-1 px-4 py-3 rounded-xl font-semibold text-slate-400 hover:bg-slate-800 hover:text-white transition-all text-center">Cancel</button>
                        <button type="submit" class="flex-1 px-4 py-3 rounded-xl font-semibold bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white shadow-lg shadow-blue-500/25 active:scale-95 transition-all flex items-center justify-center gap-2">Create Enquiry</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Convert Modal -->
    <div id="modal-convert" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-slate-900 border border-slate-700/50 rounded-2xl w-full max-w-sm p-6 md:p-8 shadow-2xl ring-1 ring-white/10">
            <h2 class="text-xl md:text-2xl font-bold mb-2 text-white">Generate Quotation</h2>
            <p class="text-slate-400 text-sm mb-8">Converting Enquiry <span id="convert-id-display" class="font-mono text-blue-400 bg-blue-400/10 px-1.5 py-0.5 rounded"></span></p>
            
            <form onsubmit="app.handleConvertSubmit(event)" class="space-y-6">
                <div>
                    <label class="block text-xs font-semibold text-slate-400 mb-1.5 uppercase tracking-wide">Quoted Price (₹)</label>
                    <div class="relative group">
                        <i data-lucide="indian-rupee" class="absolute left-4 top-3.5 text-slate-500 w-5 h-5 group-focus-within:text-purple-400 transition-colors"></i>
                        <input required id="input-price" type="number" min="0" placeholder="0.00" class="w-full bg-slate-950/50 border border-slate-700/50 rounded-xl pl-12 pr-4 py-3 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all text-xl font-bold text-white placeholder-slate-600">
                    </div>
                </div>
                
                <div class="flex flex-col-reverse sm:flex-row gap-4 mt-8">
                    <button type="button" onclick="app.toggleModal('modal-convert', false)" class="flex-1 px-4 py-3 rounded-xl font-semibold text-slate-400 hover:bg-slate-800 hover:text-white transition-all text-center">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3 rounded-xl font-semibold bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white shadow-lg shadow-purple-500/25 active:scale-95 transition-all text-center">Confirm Quote</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- DATA CONSTANTS ---
        const countryData = {
            "USA": ["Alabama", "Alaska", "Arizona", "California", "Florida", "New York", "Texas", "Washington"],
            "India": ["Andhra Pradesh", "Delhi", "Gujarat", "Karnataka", "Maharashtra", "Odisha", "Tamil Nadu", "Telangana", "Uttar Pradesh", "West Bengal"],
            "UK": ["England", "Scotland", "Wales", "Northern Ireland"],
            "Canada": ["Alberta", "British Columbia", "Ontario", "Quebec"],
            "Australia": ["New South Wales", "Queensland", "Victoria", "Western Australia"],
            "Germany": ["Bavaria", "Berlin", "Hamburg", "Hesse"],
            "France": ["Île-de-France", "Normandy", "Brittany", "Provence"],
            "Japan": ["Tokyo", "Osaka", "Kyoto", "Hokkaido"],
            "China": ["Beijing", "Shanghai", "Guangdong", "Sichuan"],
            "Brazil": ["São Paulo", "Rio de Janeiro", "Bahia", "Amazonas"]
        };

        // --- LOGIN LOGIC ---
        function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('password-input').value;
            const loginSection = document.getElementById('login-section');
            const crmApp = document.getElementById('crm-app');
            const errorMsg = document.getElementById('login-error');
            const loginCard = document.getElementById('login-card');

            if (password === '12345') {
                errorMsg.classList.add('hidden');
                loginSection.classList.add('opacity-0', 'scale-105', 'pointer-events-none');
                setTimeout(() => {
                    loginSection.classList.add('hidden');
                    crmApp.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        crmApp.classList.remove('opacity-0');
                    });
                }, 500);
            } else {
                errorMsg.classList.remove('hidden');
                loginCard.classList.add('animate-shake');
                setTimeout(() => loginCard.classList.remove('animate-shake'), 500);
            }
        }

        // --- CRM LOGIC ---
        class PixelCRM {
            constructor() {
                this.state = {
                    activeTab: 'enquiry', // enquiry, quotation, order, revenue
                    subTab: 'active',     // active, dead
                    selectedItemId: null,
                    searchQuery: '',
                    items: [],
                    uploadingItemId: null // To track which item is being uploaded to
                };

                this.navItems = [
                    { id: 'enquiry', label: 'Enquiries', icon: 'message-square', colorClass: 'text-blue-400', borderClass: 'border-blue-500' },
                    { id: 'quotation', label: 'Quotations', icon: 'file-text', colorClass: 'text-purple-400', borderClass: 'border-purple-500' },
                    { id: 'order', label: 'Orders', icon: 'shopping-cart', colorClass: 'text-emerald-400', borderClass: 'border-emerald-500' },
                    { id: 'revenue', label: 'Revenue', icon: 'bar-chart-3', colorClass: 'text-amber-400', borderClass: 'border-amber-500' }
                ];

                this.init();
            }

            init() {
                this.populateCountries();
                const dateInput = document.getElementById('input-date');
                if(dateInput) dateInput.valueAsDate = new Date();
                
                this.render();
                lucide.createIcons();
            }

            populateCountries() {
                const countrySelect = document.getElementById('input-country');
                if(!countrySelect) return;
                
                countrySelect.innerHTML = '<option value="" disabled selected>Select Country</option>';
                Object.keys(countryData).forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    countrySelect.appendChild(option);
                });
            }

            populateStates() {
                const countrySelect = document.getElementById('input-country');
                const stateSelect = document.getElementById('input-state');
                const selectedCountry = countrySelect.value;
                
                stateSelect.innerHTML = '<option value="" disabled selected>Select State</option>';
                
                if(selectedCountry && countryData[selectedCountry]) {
                    countryData[selectedCountry].forEach(state => {
                        const option = document.createElement('option');
                        option.value = state;
                        option.textContent = state;
                        stateSelect.appendChild(option);
                    });
                } else {
                    stateSelect.innerHTML = '<option value="" disabled selected>No States Available</option>';
                }
            }

            handleSearch(query) {
                this.state.searchQuery = query.toLowerCase().trim();
                this.renderList(); 
            }

            setActiveTab(tab) {
                if (this.state.activeTab === tab) return;
                this.state.activeTab = tab;
                this.state.subTab = 'active'; 
                this.render();
            }

            setSubTab(tab) {
                if (this.state.subTab === tab) return;
                this.state.subTab = tab;
                this.render();
            }

            toggleModal(modalId, show) {
                const el = document.getElementById(modalId);
                const content = el.querySelector('div');
                
                if (show) {
                    el.classList.remove('hidden');
                    setTimeout(() => {
                        el.classList.remove('opacity-0');
                        content.classList.remove('scale-95', 'opacity-0');
                        content.classList.add('scale-100', 'opacity-100');
                        const input = el.querySelector('input');
                        if(input) input.focus();
                        if(modalId === 'modal-add') {
                             const dateInput = document.getElementById('input-date');
                             if(dateInput && !dateInput.value) dateInput.valueAsDate = new Date();
                        }
                    }, 10);
                } else {
                    el.classList.add('opacity-0');
                    content.classList.remove('scale-100', 'opacity-100');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        el.classList.add('hidden');
                    }, 300);
                }
            }

            generateId() {
                const lastId = this.state.items.length > 0 ? this.state.items[this.state.items.length - 1].id : 'PP000';
                const num = parseInt(lastId.replace('PP', '')) + 1;
                return `PP${String(num).padStart(3, '0')}`;
            }

            handleAddEnquiry(e) {
                e.preventDefault();
                const name = document.getElementById('input-name').value;
                const company = document.getElementById('input-company').value;
                const mobile = document.getElementById('input-mobile').value;
                const email = document.getElementById('input-email').value;
                const address = document.getElementById('input-address').value;
                const companyAddress = document.getElementById('input-company-address').value;
                const country = document.getElementById('input-country').value;
                const state = document.getElementById('input-state').value;
                const website = document.getElementById('input-website').value;
                const desc = document.getElementById('input-desc').value;
                const dateVal = document.getElementById('input-date').value;

                const newItem = {
                    id: this.generateId(),
                    type: 'enquiry',
                    status: 'active',
                    paymentStatus: 'unpaid',
                    isCancelled: false, 
                    poUploaded: false, // New property for PO tracking
                    name, company, mobile, email, address, companyAddress, country, state, website, desc,
                    value: 0,
                    date: dateVal || new Date().toLocaleDateString()
                };

                this.state.items.push(newItem);
                e.target.reset();
                document.getElementById('input-date').valueAsDate = new Date();
                
                this.toggleModal('modal-add', false);
                this.render();
            }

            openConvertModal(id) {
                this.state.selectedItemId = id;
                document.getElementById('convert-id-display').textContent = id;
                document.getElementById('input-price').value = '';
                this.toggleModal('modal-convert', true);
            }

            handleConvertSubmit(e) {
                e.preventDefault();
                const price = Number(document.getElementById('input-price').value);
                const itemIndex = this.state.items.findIndex(i => i.id === this.state.selectedItemId);
                if (itemIndex > -1) {
                    this.state.items[itemIndex].type = 'quotation';
                    this.state.items[itemIndex].value = price;
                    this.toggleModal('modal-convert', false);
                    setTimeout(() => this.setActiveTab('quotation'), 300);
                }
            }

            markAsOrder(id) {
                const item = this.state.items.find(i => i.id === id);
                if (item) {
                    item.type = 'order'; 
                    item.status = 'active'; 
                    if (!item.paymentStatus) item.paymentStatus = 'unpaid';
                    this.setActiveTab('order'); 
                }
            }
            
            togglePaymentStatus(id) {
                const item = this.state.items.find(i => i.id === id);
                if (item && !item.isCancelled) { 
                    item.paymentStatus = (item.paymentStatus === 'paid') ? 'unpaid' : 'paid';
                    this.render(); 
                }
            }
            
            toggleRefundStatus(id) {
                const item = this.state.items.find(i => i.id === id);
                if (item) {
                    if(item.paymentStatus === 'refunded') {
                        item.paymentStatus = 'paid';
                    } else {
                        item.paymentStatus = 'refunded';
                    }
                    this.render();
                }
            }
            
            cancelItem(id) {
                const item = this.state.items.find(i => i.id === id);
                if (item) {
                    item.isCancelled = true;
                    // Move Enquiries and Quotes to Dead
                    if (item.type !== 'order') {
                        item.status = 'dead';
                    } 
                    // Remove the line forcing 'unpaid' status so it remains in Revenue if already paid
                    // if (item.paymentStatus === 'paid') item.paymentStatus = 'unpaid'; 
                    
                    this.render();
                }
            }

            markAsRefunded(id) {
                const item = this.state.items.find(i => i.id === id);
                if (item) {
                    item.paymentStatus = 'refunded';
                    item.isCancelled = false; 
                    this.render();
                }
            }

            markStatus(id, status) {
                const item = this.state.items.find(i => i.id === id);
                if (item) {
                    item.status = status;
                    if (status === 'active') {
                        item.isCancelled = false; 
                    }
                    this.render();
                }
            }

            // --- FILE UPLOAD LOGIC ---
            triggerUpload(id) {
                this.state.uploadingItemId = id;
                const fileInput = document.getElementById('po-uploader');
                fileInput.value = ''; // Reset
                fileInput.click();
            }

            handleFileSelection(input) {
                if (input.files && input.files[0] && this.state.uploadingItemId) {
                    const item = this.state.items.find(i => i.id === this.state.uploadingItemId);
                    if (item) {
                        item.poUploaded = true;
                        this.render();
                        // Optional: Show toast message here if you implemented a toast system
                    }
                }
                this.state.uploadingItemId = null;
            }

            // --- PDF Generation ---

            downloadPO(id) {
                const item = this.state.items.find(i => i.id === id);
                if (!item) return;
                this.generatePDF(item, "PURCHASE ORDER", `PO-${item.id}.pdf`);
            }

            downloadQuote(id) {
                const item = this.state.items.find(i => i.id === id);
                if (!item) return;
                this.generatePDF(item, "QUOTATION", `Quote-${item.id}.pdf`);
            }

            generatePDF(item, title, filename) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header Background
                doc.setFillColor(248, 250, 252);
                doc.rect(0, 0, 210, 40, 'F');
                
                // Brand
                doc.setFontSize(24);
                doc.setTextColor(37, 99, 235);
                doc.text("Pixel CRM", 20, 25);
                
                // Address
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                doc.text("123 Innovation Drive, Tech Valley, CA 94043", 20, 32);
                
                // Document Title
                doc.setFontSize(20);
                doc.setTextColor(15, 23, 42);
                doc.text(title, 130, 25);
                
                // Meta Data
                doc.setFontSize(10);
                doc.setTextColor(71, 85, 105);
                doc.text(`${title === 'QUOTATION' ? 'Quote' : 'PO'} Number:`, 130, 35);
                doc.text(`Date:`, 130, 40);
                
                // Status Stamp
                if (item.isCancelled) {
                    doc.setTextColor(220, 38, 38);
                    doc.text("(CANCELLED)", 130, 50);
                } else if (item.paymentStatus === 'refunded') {
                    doc.setTextColor(234, 179, 8);
                    doc.text("(REFUNDED)", 130, 50);
                }

                // Data Values
                doc.setTextColor(15, 23, 42);
                doc.setFont("helvetica", "bold");
                doc.text(item.id, 160, 35);
                doc.text(item.date || new Date().toLocaleDateString(), 160, 40);
                
                // Divider
                doc.setFont("helvetica", "normal");
                doc.setDrawColor(226, 232, 240);
                doc.line(20, 55, 190, 55);
                
                // Bill To
                doc.setFontSize(10);
                doc.setTextColor(100, 116, 139);
                doc.text("BILL TO", 20, 65);
                
                doc.setFontSize(12);
                doc.setTextColor(15, 23, 42);
                doc.setFont("helvetica", "bold");
                doc.text(item.company || item.name, 20, 72); 
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(71, 85, 105);
                
                let y = 78;
                if(item.company) { doc.text(`Attn: ${item.name}`, 20, y); y+=5; }
                doc.text(item.companyAddress || item.address, 20, y); y+=5;
                doc.text(`${item.state}, ${item.country}`, 20, y); y+=5;
                doc.text(item.email, 20, y); y+=5;
                doc.text(item.mobile, 20, y);

                // Table Header
                doc.setFillColor(241, 245, 249);
                doc.rect(20, 105, 170, 10, 'F');
                doc.setFontSize(9);
                doc.setTextColor(71, 85, 105);
                doc.setFont("helvetica", "bold");
                doc.text("DESCRIPTION", 25, 111);
                doc.text("AMOUNT", 165, 111);
                
                // Table Content
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(30, 41, 59);
                
                const splitDesc = doc.splitTextToSize(item.desc, 130);
                doc.text(splitDesc, 25, 125);
                
                doc.setFont("helvetica", "bold");
                doc.text(`Rs. ${item.value.toLocaleString()}`, 165, 125);
                
                // Footer Line
                let yPos = 125 + (splitDesc.length * 5) + 5;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, yPos, 190, yPos);
                
                // Total
                yPos += 10;
                doc.setFontSize(12);
                doc.setTextColor(71, 85, 105);
                doc.text("Total", 130, yPos);
                
                doc.setFontSize(16);
                doc.setTextColor(37, 99, 235);
                doc.text(`Rs. ${item.value.toLocaleString()}`, 160, yPos);
                
                // Footer Text
                doc.setFontSize(8);
                doc.setTextColor(148, 163, 184);
                doc.text("Thank you for choosing Pixel CRM. If you have any questions, please contact support.", 105, 280, null, null, "center");
                
                doc.save(filename);
            }

            render() {
                this.renderNav();
                this.renderHeader();
                this.renderStats();
                this.renderList();
                lucide.createIcons();
            }

            renderNav() {
                const container = document.getElementById('main-nav');
                container.innerHTML = this.navItems.map(item => {
                    const isActive = this.state.activeTab === item.id;
                    const baseClasses = "flex items-center gap-2.5 py-4 border-b-2 transition-all duration-300 group relative";
                    const activeClasses = `${item.borderClass} ${item.colorClass}`;
                    const inactiveClasses = "border-transparent text-slate-500 hover:text-slate-200 hover:border-slate-800";
                    
                    return `
                        <button onclick="app.setActiveTab('${item.id}')" class="${baseClasses} ${isActive ? activeClasses : inactiveClasses}">
                            <div class="${isActive ? '' : 'group-hover:-translate-y-0.5 transition-transform duration-300'}">
                                <i data-lucide="${item.icon}" class="w-5 h-5 ${isActive ? 'drop-shadow-md' : 'opacity-70'}"></i>
                            </div>
                            <span class="font-medium tracking-wide ${isActive ? 'font-bold' : ''}">${item.label}</span>
                            ${isActive ? `<div class="absolute inset-0 bg-gradient-to-t from-white/5 to-transparent pointer-events-none"></div>` : ''}
                        </button>
                    `;
                }).join('');
            }

            renderHeader() {
                const titleEl = document.getElementById('page-title');
                const activeNavItem = this.navItems.find(i => i.id === this.state.activeTab);
                
                titleEl.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    titleEl.innerHTML = `
                        <span class="${activeNavItem.colorClass} drop-shadow-sm">${activeNavItem.label}</span>
                    `;
                    titleEl.classList.remove('opacity-0', 'translate-y-2');
                }, 150);

                const subtabContainer = document.getElementById('subtab-container');
                if (this.state.activeTab === 'revenue') {
                    subtabContainer.classList.add('hidden');
                } else {
                    subtabContainer.classList.remove('hidden');
                    const btnActive = document.getElementById('btn-subtab-active');
                    const btnDead = document.getElementById('btn-subtab-dead');

                    if (this.state.subTab === 'active') {
                        btnActive.className = "flex-1 sm:flex-none px-4 py-1.5 rounded-md text-white bg-slate-700 shadow-lg shadow-black/20 font-medium transition-all duration-300 text-center";
                        btnDead.className = "flex-1 sm:flex-none px-4 py-1.5 rounded-md text-slate-500 hover:text-slate-300 hover:bg-slate-800/50 transition-all duration-300 text-center";
                    } else {
                        btnActive.className = "flex-1 sm:flex-none px-4 py-1.5 rounded-md text-slate-500 hover:text-slate-300 hover:bg-slate-800/50 transition-all duration-300 text-center";
                        btnDead.className = "flex-1 sm:flex-none px-4 py-1.5 rounded-md text-red-400 bg-red-500/10 shadow-lg shadow-red-900/10 font-medium transition-all duration-300 text-center";
                    }
                }

                const actionsEl = document.getElementById('header-actions');
                if (this.state.activeTab === 'enquiry' && this.state.subTab === 'active') {
                    actionsEl.innerHTML = `
                        <button onclick="app.toggleModal('modal-add', true)" class="w-full md:w-auto px-5 py-2.5 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 hover:-translate-y-0.5 active:scale-95 group">
                            <i data-lucide="plus" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300"></i>
                            <span class="inline">Add Enquiry</span>
                        </button>
                    `;
                } else {
                    actionsEl.innerHTML = '';
                }
            }

            createStatCard(title, value, icon, colorClass, delay = 0) {
                let bgClass = "bg-blue-500/10";
                let textClass = "text-blue-400";
                
                if (colorClass === 'emerald') { bgClass = "bg-emerald-500/10"; textClass = "text-emerald-400"; }
                if (colorClass === 'purple') { bgClass = "bg-purple-500/10"; textClass = "text-purple-400"; }
                if (colorClass === 'amber') { bgClass = "bg-amber-500/10"; textClass = "text-amber-400"; }
                if (colorClass === 'red') { bgClass = "bg-red-500/10"; textClass = "text-red-400"; }
                
                return `
                    <div class="card-glass rounded-2xl p-6 shadow-xl relative overflow-hidden group hover:bg-slate-800/50 transition-colors duration-300 animate-slide-up" style="animation-delay: ${delay}ms">
                        <div class="absolute -right-6 -top-6 w-32 h-32 ${bgClass} rounded-full blur-3xl transition-all duration-500 group-hover:opacity-70"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="p-1.5 rounded-lg ${bgClass} ${textClass}">
                                    <i data-lucide="${icon}" class="w-4 h-4"></i>
                                </div>
                                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">${title}</p>
                            </div>
                            <h3 class="text-3xl md:text-4xl font-bold text-white tracking-tight">${value}</h3>
                        </div>
                    </div>
                `;
            }

            renderStats() {
                const container = document.getElementById('stats-container');
                let cardsHtml = '';
                const items = this.state.items.filter(i => i.type === this.state.activeTab); 

                if (this.state.activeTab === 'enquiry') {
                    const total = items.length;
                    const active = items.filter(i => i.status === 'active').length;
                    const dead = items.filter(i => i.status === 'dead').length;

                    cardsHtml += this.createStatCard('Total Enquiries', total, 'layers', 'blue', 0);
                    cardsHtml += this.createStatCard('Active Enquiries', active, 'activity', 'blue', 100);
                    cardsHtml += this.createStatCard('Dead Enquiries', dead, 'x-circle', 'red', 200);
                } 
                else if (this.state.activeTab === 'quotation') {
                    const total = items.length;
                    const active = items.filter(i => i.status === 'active').length;
                    const dead = items.filter(i => i.status === 'dead').length;
                    const activeValue = items.filter(i => i.status === 'active').reduce((acc, curr) => acc + (curr.value || 0), 0);
                    const cancelledValue = items.filter(i => i.status === 'dead').reduce((acc, curr) => acc + (curr.value || 0), 0);

                    cardsHtml += this.createStatCard('Total Quotations', total, 'layers', 'purple', 0);
                    cardsHtml += this.createStatCard('Active', active, 'activity', 'purple', 100);
                    cardsHtml += this.createStatCard('Cancelled Value', `₹${cancelledValue.toLocaleString()} <span class="text-lg text-red-300/50 font-medium ml-1">(${dead})</span>`, 'x-circle', 'red', 200);
                    cardsHtml += this.createStatCard('Active Value', '₹' + activeValue.toLocaleString(), 'indian-rupee', 'emerald', 300);
                }
                else if (this.state.activeTab === 'revenue') {
                    const validItems = this.state.items.filter(i => i.type === 'order' && (i.paymentStatus === 'paid' || i.paymentStatus === 'refunded'));
                    const transactions = validItems.length;
                    
                    const refundedItems = validItems.filter(i => i.paymentStatus === 'refunded');
                    const refundedCount = refundedItems.length;
                    const refundedValue = refundedItems.reduce((acc, curr) => acc + (curr.value || 0), 0);
                    
                    const netRevenue = validItems.reduce((acc, curr) => {
                        if (curr.paymentStatus === 'refunded') return acc;
                        return acc + (curr.value || 0);
                    }, 0);

                    cardsHtml += this.createStatCard('Transactions', transactions, 'layers', 'amber', 0);
                    cardsHtml += this.createStatCard('Net Revenue', '₹' + netRevenue.toLocaleString(), 'indian-rupee', 'emerald', 100);
                    cardsHtml += this.createStatCard('Refunded Orders', refundedCount, 'rotate-ccw', 'red', 200);
                    cardsHtml += this.createStatCard('Refunded Amount', '₹' + refundedValue.toLocaleString(), 'minus-circle', 'red', 300);
                }
                else {
                    // Order
                    const total = items.length;
                    const active = items.filter(i => i.status === 'active').length;
                    const cancelled = items.filter(i => i.isCancelled).length;
                    const activeValue = items.filter(i => !i.isCancelled).reduce((acc, curr) => acc + (curr.value || 0), 0);
                    
                    cardsHtml += this.createStatCard('Total Orders', total, 'layers', 'emerald', 0);
                    cardsHtml += this.createStatCard('Active', active, 'activity', 'emerald', 100);
                    cardsHtml += this.createStatCard('Cancelled', cancelled, 'ban', 'red', 200);
                    cardsHtml += this.createStatCard('Total Order Value', '₹' + activeValue.toLocaleString(), 'indian-rupee', 'emerald', 300);
                }

                container.innerHTML = cardsHtml;
            }

            renderList() {
                const container = document.getElementById('items-list');
                const searchQuery = this.state.searchQuery;
                
                let filtered;
                if (this.state.activeTab === 'revenue') {
                    filtered = this.state.items.filter(i => i.type === 'order' && (i.paymentStatus === 'paid' || i.paymentStatus === 'refunded'));
                } else {
                    filtered = this.state.items.filter(i => i.type === this.state.activeTab && (this.state.activeTab === 'order' ? true : i.status === this.state.subTab));
                }

                // Filter by Search
                if(searchQuery) {
                    filtered = filtered.filter(item => 
                        item.id.toLowerCase().includes(searchQuery) ||
                        item.name.toLowerCase().includes(searchQuery) ||
                        (item.company && item.company.toLowerCase().includes(searchQuery)) ||
                        item.mobile.includes(searchQuery) ||
                        item.email.toLowerCase().includes(searchQuery)
                    );
                }

                if (filtered.length === 0) {
                    let emptyMsg = `No ${this.state.subTab} ${this.state.activeTab}s found.`;
                    if(searchQuery) emptyMsg = "No results found for your search.";
                    if (this.state.activeTab === 'revenue') emptyMsg = "No revenue collected yet.";
                    
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64 border-2 border-dashed border-slate-800 rounded-2xl text-slate-500 animate-fade-in bg-slate-900/20">
                            <div class="p-4 bg-slate-800/50 rounded-full mb-4">
                                <i data-lucide="search" class="w-8 h-8 opacity-40"></i>
                            </div>
                            <p class="font-medium">${emptyMsg}</p>
                            ${this.state.activeTab === 'enquiry' && !searchQuery ? '<p class="text-sm opacity-60 mt-1">Get started by creating a new entry.</p>' : ''}
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filtered.map((item, index) => {
                    let badgeColor = "bg-slate-500/10 text-slate-400 border-slate-500/20";
                    let typeLabel = "";
                    let glowClass = ""; 

                    if (item.type === 'quotation') {
                        badgeColor = "bg-purple-500/10 text-purple-400 border-purple-500/20";
                        typeLabel = "Quote";
                        glowClass = "border-l-4 border-l-purple-500";
                    } else if (item.type === 'order') {
                        badgeColor = "bg-emerald-500/10 text-emerald-400 border-emerald-500/20";
                        typeLabel = "Order";
                        glowClass = "border-l-4 border-l-emerald-500";
                    } else {
                        glowClass = "border-l-4 border-l-blue-500";
                    }
                    
                    let statusBadge = "";
                    if (item.isCancelled) {
                        statusBadge = `<span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border bg-red-500/10 text-red-400 border-red-500/20 ml-2">Cancelled</span>`;
                    } else if (item.paymentStatus === 'paid') {
                        statusBadge = `<span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border bg-amber-500/10 text-amber-400 border-amber-500/20 ml-2">Paid</span>`;
                    } else if (item.paymentStatus === 'refunded') {
                        statusBadge = `<span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border bg-pink-500/10 text-pink-400 border-pink-500/20 ml-2">Refunded</span>`;
                    }

                    const cancelBtn = `
                        <button onclick="app.cancelItem('${item.id}')" class="flex-1 md:flex-none px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 text-sm shadow-md active:scale-95 border border-red-500/30 text-red-400 hover:bg-red-500/10 hover:text-red-300" title="Cancel/Invalidate">
                            <i data-lucide="ban" class="w-4 h-4"></i>
                        </button>
                    `;

                    let actionsHtml = '';
                    const baseBtn = "flex-1 md:flex-none px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 text-sm shadow-md active:scale-95";
                    
                    const markDeadBtn = `
                        <button onclick="app.markStatus('${item.id}', 'dead')" class="p-2.5 rounded-lg text-slate-500 hover:bg-red-500/10 hover:text-red-400 transition-all duration-200" title="Move to Dead/Lost">
                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                        </button>
                    `;

                    if (this.state.activeTab === 'revenue') {
                         const refundLabel = item.paymentStatus === 'refunded' ? 'Refunded' : 'Refund';
                         const refundIcon = item.paymentStatus === 'refunded' ? 'check' : 'rotate-ccw';
                         const refundBtnColor = item.paymentStatus === 'refunded' 
                            ? "border border-pink-500 bg-pink-500/10 text-pink-400" 
                            : "border border-pink-500/30 text-pink-400 hover:bg-pink-500/10 hover:text-pink-300";
                         
                         actionsHtml = `
                            <button onclick="app.toggleRefundStatus('${item.id}')" class="${baseBtn} ${refundBtnColor}">
                                ${refundLabel} <i data-lucide="${refundIcon}" class="w-4 h-4"></i>
                            </button>
                            ${item.isCancelled ? '' : cancelBtn}
                            <button onclick="app.downloadPO('${item.id}')" class="${baseBtn} bg-slate-700 hover:bg-slate-600 text-slate-200 hover:text-white shadow-lg">
                                <i data-lucide="download" class="w-4 h-4"></i> PO
                            </button>
                        `;
                    } else if (this.state.subTab === 'dead' && !item.isCancelled) {
                        actionsHtml = `
                            <button onclick="app.markStatus('${item.id}', 'active')" class="${baseBtn} border border-slate-600 text-slate-300 hover:bg-slate-800 hover:text-white hover:border-slate-500">
                                <i data-lucide="archive-restore" class="w-4 h-4"></i> Restore
                            </button>
                        `;
                    } else if (item.isCancelled) {
                         actionsHtml = `
                            ${this.state.activeTab !== 'order' ? markDeadBtn : ''}
                            <button disabled class="${baseBtn} bg-red-500/10 text-red-500 border border-red-500/20 cursor-not-allowed opacity-75">
                                Cancelled <i data-lucide="ban" class="w-4 h-4"></i>
                            </button>
                        `;
                    } else {
                        if (item.type === 'enquiry') {
                            actionsHtml = `
                                ${markDeadBtn}
                                ${cancelBtn}
                                <button onclick="app.openConvertModal('${item.id}')" class="${baseBtn} bg-blue-600 hover:bg-blue-500 text-white shadow-blue-900/20 hover:shadow-blue-500/30">
                                    Convert Quote <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                </button>
                            `;
                        } else if (item.type === 'quotation') {
                            actionsHtml = `
                                ${markDeadBtn}
                                ${cancelBtn}
                                <button onclick="app.downloadQuote('${item.id}')" class="${baseBtn} bg-purple-600 hover:bg-purple-500 text-white shadow-purple-900/20 hover:shadow-purple-500/30">
                                    <i data-lucide="download" class="w-4 h-4"></i> Quote
                                </button>
                                <button onclick="app.markAsOrder('${item.id}')" class="${baseBtn} bg-emerald-600 hover:bg-emerald-500 text-white shadow-emerald-900/20 hover:shadow-emerald-500/30">
                                    Convert Order <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                                </button>
                            `;
                        } else if (item.type === 'order') {
                            let payBtn;
                            if (item.paymentStatus === 'paid') {
                                payBtn = `
                                    <button onclick="app.togglePaymentStatus('${item.id}')" class="${baseBtn} border border-green-500/30 text-green-500 hover:bg-green-500/10 hover:text-green-400">
                                        Paid <i data-lucide="check" class="w-4 h-4"></i>
                                    </button>
                                `;
                            } else if (item.paymentStatus === 'refunded') {
                                payBtn = `
                                    <span class="text-xs font-bold text-pink-400 uppercase tracking-widest mr-2 px-3">Refunded</span>
                                `;
                            } else {
                                payBtn = `
                                    <button onclick="app.togglePaymentStatus('${item.id}')" class="${baseBtn} border border-slate-600 text-slate-400 hover:bg-slate-800 hover:text-white">
                                        Pending <i data-lucide="clock" class="w-4 h-4"></i>
                                    </button>
                                `;
                            }
                            
                            // Upload Button Logic
                            const uploadBtn = item.poUploaded 
                                ? `<button onclick="app.triggerUpload('${item.id}')" class="${baseBtn} border border-green-500/30 text-green-500 hover:bg-green-500/10 hover:text-green-400">PO Uploaded <i data-lucide="check" class="w-4 h-4"></i></button>`
                                : `<button onclick="app.triggerUpload('${item.id}')" class="${baseBtn} border border-blue-500/30 text-blue-400 hover:bg-blue-500/10 hover:text-blue-300">Upload PO <i data-lucide="upload" class="w-4 h-4"></i></button>`;

                            actionsHtml = `
                                ${payBtn}
                                ${cancelBtn}
                                ${uploadBtn}
                                <button onclick="app.downloadPO('${item.id}')" class="${baseBtn} bg-slate-700 hover:bg-slate-600 text-slate-200 hover:text-white shadow-lg">
                                    <i data-lucide="download" class="w-4 h-4"></i> PO
                                </button>
                            `;
                        }
                    }
                    
                    if (item.status === 'dead' || item.isCancelled) {
                        glowClass = "border-l-4 border-l-red-500";
                    } else if (item.paymentStatus === 'refunded') {
                        glowClass = "border-l-4 border-l-pink-500";
                    }

                    const opacityClass = (item.isCancelled || item.paymentStatus === 'refunded') ? "opacity-75" : "";

                    return `
                        <div class="card-glass hover-lift rounded-xl p-4 md:p-5 flex flex-col md:flex-row md:items-center justify-between gap-6 stagger-item group relative overflow-hidden ${opacityClass}" style="animation-delay: ${index * 70}ms">
                            <div class="absolute left-0 top-0 bottom-0 w-1 ${glowClass.replace('border-l-4 border-l-', 'bg-')}"></div>
                            
                            <div class="flex-1 pl-3">
                                <div class="flex flex-wrap items-center gap-2 md:gap-3 mb-2">
                                    <span class="font-mono text-xs text-slate-500 bg-slate-950/50 border border-slate-800 px-2 py-1 rounded-md tracking-wider">${item.id}</span>
                                    <h4 class="font-bold text-base md:text-lg text-slate-100 group-hover:text-white transition-colors ${item.status === 'dead' ? 'text-slate-500' : ''}">${item.company || item.name}</h4>
                                    ${item.company ? `<span class="hidden sm:inline text-xs text-slate-500 ml-2 border border-slate-700 px-2 py-0.5 rounded">${item.name}</span>` : ''}
                                    ${typeLabel ? `<span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border ${badgeColor}">${typeLabel}</span>` : ''}
                                    ${statusBadge}
                                </div>
                                <p class="text-slate-400 text-sm mb-4 line-clamp-1 group-hover:text-slate-300 transition-colors">${item.desc}</p>
                                
                                <div class="flex flex-wrap items-center gap-4 text-sm text-slate-500">
                                     <span class="flex items-center gap-2 hover:text-blue-400 transition-colors cursor-default">
                                        <i data-lucide="calendar" class="w-3.5 h-3.5"></i> ${item.date || 'N/A'}
                                    </span>
                                    <span class="flex items-center gap-2 hover:text-blue-400 transition-colors cursor-default">
                                        <i data-lucide="mail" class="w-3.5 h-3.5"></i> ${item.email}
                                    </span>
                                    <span class="flex items-center gap-2 hover:text-blue-400 transition-colors cursor-default">
                                        <i data-lucide="smartphone" class="w-3.5 h-3.5"></i> ${item.mobile}
                                    </span>
                                    ${item.value > 0 ? `
                                        <span class="flex items-center gap-2 text-emerald-400 font-bold bg-emerald-500/5 px-2 py-0.5 rounded-md border border-emerald-500/10 ${item.isCancelled ? 'line-through opacity-50' : ''}">
                                            <i data-lucide="indian-rupee" class="w-3.5 h-3.5"></i> ${item.value.toLocaleString()}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="flex flex-wrap items-center gap-3 self-start md:self-center opacity-100 md:opacity-90 group-hover:opacity-100 transition-opacity z-10 w-full md:w-auto">
                                ${actionsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        const app = new PixelCRM();
    </script>
</body>
</html>
